name: Build & Validate OpenPackage

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'
      - '.opencode/**'
      - 'openpackage.yml'
      - 'scripts/build-openpackage.ts'
  pull_request:
    branches: [main]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'
      - '.opencode/**'
      - 'openpackage.yml'
      - 'scripts/build-openpackage.ts'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: bun install

      - name: Install OpenPackage CLI
        run: npm install -g opkg

      - name: Generate OpenPackage manifests
        run: bun run build:openpackage

      - name: Validate root manifest
        run: |
          echo "Validating root openpackage.yml..."
          if [ ! -f "openpackage.yml" ]; then
            echo "ERROR: Root openpackage.yml not found"
            exit 1
          fi
          echo "Root manifest exists"

      - name: Validate plugin manifests
        run: |
          echo "Validating plugin manifests..."
          MISSING=0
          for dir in plugins/*/; do
            if [ ! -f "${dir}openpackage.yml" ]; then
              echo "WARNING: Missing manifest in ${dir}"
              MISSING=$((MISSING + 1))
            fi
          done
          echo "Checked $(ls -d plugins/*/ | wc -l) plugins"
          echo "Missing manifests: $MISSING"

      - name: Show OpenPackage info
        run: opkg show . || echo "opkg show not available for local directories"

      - name: List generated files
        run: |
          echo "=== Root manifest ==="
          cat openpackage.yml
          echo ""
          echo "=== Sample plugin manifest (debugging-toolkit) ==="
          cat plugins/debugging-toolkit/openpackage.yml || echo "Not found"
          echo ""
          echo "=== PLUGINS.md preview ==="
          head -50 PLUGINS.md || echo "Not found"

      - name: Upload manifests as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openpackage-manifests
          path: |
            openpackage.yml
            plugins/*/openpackage.yml
            PLUGINS.md
          retention-days: 7

  test-install:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install OpenPackage CLI
        run: npm install -g opkg

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: openpackage-manifests

      - name: Test local install (dry-run simulation)
        run: |
          echo "Testing OpenPackage structure..."
          echo "Available plugins:"
          ls plugins/ | head -20
          echo ""
          echo "Manifest validation complete"
          echo ""
          echo "After merging, users can install with:"
          echo "  opkg install gh@esimplicityinc/prima-delivery"
          echo "  opkg install gh@esimplicityinc/prima-delivery --plugins debugging-toolkit"
